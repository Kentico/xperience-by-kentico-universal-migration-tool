name: "CI: Build and Test"

on:
  push:
    branches: [main]
    paths:
      - "**.cs"
      - "**.cshtml"
      - "**.tsx"
      - "**.js"
      - "**.json"
      - "**.csproj"
      - "**.props"
      - "**.targets"
      - "**.sln"
      - "**.yml"
  pull_request:
    branches: [main]
    paths:
      - "**.cs"
      - "**.cshtml"
      - "**.tsx"
      - "**.js"
      - "**.json"
      - "**.csproj"
      - "**.targets"
      - "**.sln"
      - "**.yml"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  XBK_DIR: "${{ github.workspace }}/xbk"
  UMT_DIR: "${{ github.workspace }}/umt"
  DB_USER: "kentico"
  DB_DATABASE: "pwtest"
  LICENSE_FILE: "${{ github.workspace }}/license.txt"
  XBK_URL: ""
  SA_PASSWORD: "Your_password123"

jobs:
  build:
    runs-on: ubuntu-latest 
    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2019-latest
        env:
          SA_PASSWORD: "${{ env.SA_PASSWORD }}"
          ACCEPT_EULA: "Y"
        ports:
          - 1433:1433
        options: >-
          --health-cmd "exit 0"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          path: ${{ env.UMT_DIR }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4

      # - name: <DB> Create Kentico DB user
      #   run: |
      #     sqlcmd -Q "CREATE LOGIN ${{ env.DB_USER}} WITH PASSWORD = '${{ secrets.XPERIENCE_BY_KENTICO_DB_PASSWORD }}';
      #     CREATE USER kentico FOR LOGIN kentico;
      #     GO"

      # - name: <DB> Add kentico user to sysadmin role
      #   run: |
      #     sqlcmd -Q "sp_addsrvrolemember '${{ env.DB_USER}}', 'sysadmin';
      #     GO"

      # - name: <DB> Enable SQL authentication
      #   run: |
      #     Write-Output "SQL Server: Setting Mixed Mode Authentication."
      #     New-ItemProperty 'HKLM:\Software\Microsoft\Microsoft SQL Server\MSSQL16.SQLEXPRESS\MSSQLServer\' -Name 'LoginMode' -Value 2 -Force
      #     Write-Output "SQL Server: Forcing Restart of Instance."
      #     Restart-Service -Force 'MSSQL$SQLEXPRESS'

      # - name: <DB> Create database
      #   run: |
      #     sqlcmd -S "${{ env.SQLSERVER_NAME}}" -U '${{ env.DB_USER}}' -P '${{ secrets.XPERIENCE_BY_KENTICO_DB_PASSWORD }}' -Q "CREATE DATABASE ${{ env.DB_DATABASE}};"

      # Xperience by Kentico setup
      - name: <XbK> Install kentico templates
        working-directory: ${{ env.UMT_DIR }}
        run: |
          XBK_CORE_VERSION=$(grep -oP '(?<=<PackageVersion Include="Kentico.Xperience.Core" Version=")[^"]*' Directory.Packages.props)
          echo "XBK_CORE_VERSION: $XBK_CORE_VERSION"
          echo "Kentico.Xperience.Core version: $XBK_CORE_VERSION"

          mkdir ${{ env.XBK_DIR }}
          cd ${{ env.XBK_DIR }}
          dotnet new install Kentico.Xperience.Templates::$XBK_CORE_VERSION

      - name: <XbK> Create Kentico Xperience project
        working-directory: ${{ env.XBK_DIR }}
        run: |
          echo "y" | dotnet new kentico-xperience-mvc -n kentico-boilerplate

      - name: <XbK> Run kentico dbmanager with license
        working-directory: ${{ env.XBK_DIR }}
        run: |
          echo ${{ secrets.XPERIENCE_BY_KENTICO_LICENSE }} > ${{ env.LICENCE_FILE }}
          dotnet kentico-xperience-dbmanager -- -s "localhost" -d "pwtest" -u "sa" -p "${{ env.SA_PASSWORD }}" -a "${{ secrets.XPERIENCE_BY_KENTICO_ADMIN_PASSWORD }}" --recreate-existing-database --hash-string-salt "<hash_string_salt>" --license-file "${{ env.LICENCE_FILE }}"
          rm ${{ env.LICENCE_FILE }}

      - name: <UMT> Prepare appsettings.json for migration
        working-directory: ${{ env.UMT_DIR }}
        run: |
          EXAMPLE_APPSETTINGS="examples/Kentico.Xperience.UMT.Example.Console/appsettings.json"
          CMS_CONNECTION_STRING=$(jq -r '.ConnectionStrings.CMSConnectionString' "${{ env.XBK_DIR }}/appsettings.json")
          
          # Update the appsettings.json file with new values
          jq --arg conn "$CMS_CONNECTION_STRING" \
             --arg path "${{ env.XBK_DIR }}" \
             '.ConnectionStrings.CMSConnectionString = $conn | .WebApplicationPhysicalPath = $path' \
             "$EXAMPLE_APPSETTINGS" > temp_appsettings.json
          
          mv temp_appsettings.json "$EXAMPLE_APPSETTINGS"
          cat "$EXAMPLE_APPSETTINGS"

      - name: <UMT> Install dependencies and build
        working-directory: ${{ env.UMT_DIR }}
        run: |
          dotnet restore --locked-mode
          dotnet tool restore
          dotnet build

      - name: <UMT> Run example migration
        working-directory: ${{ env.UMT_DIR }}\examples\Kentico.Xperience.UMT.Example.Console\
        run: |
          dotnet run --no-build

      - name: Install Playwright
        working-directory: ${{ env.UMT_DIR }}\tests\Kentico.Xperience.UMT.Tests
        run: |
          bin\Debug\net8.0\playwright.sh install --with-deps

      - name: Prepare test.runsettings
        working-directory: ${{ env.UMT_DIR }}
        run: |
          cat "${{ env.XBK_DIR }}/Properties/launchSettings.json"
          url=$(jq -r '.profiles.kentico_boilerplate.applicationUrl' "${{ env.XBK_DIR }}/Properties/launchSettings.json")
          echo "XBK_URL=$url" >> $GITHUB_ENV

          echo "Setting XbK URL for tests: $url"
          sed -i "s|<BASE_URL>[^<]*</BASE_URL>|<BASE_URL>$url</BASE_URL>|g" test.runsettings
          sed -i "s|<ADMINISTRATION_PASSWORD>[^<]*</ADMINISTRATION_PASSWORD>|<ADMINISTRATION_PASSWORD>${{ secrets.XPERIENCE_BY_KENTICO_ADMIN_PASSWORD }}</ADMINISTRATION_PASSWORD>|g" test.runsettings
          cat test.runsettings

      - name: Start xbk and run tests
        run: |
          cd ${{ env.XBK_DIR }}
          dotnet run --project "${{ env.XBK_DIR }}/kentico-boilerplate.csproj" &
          XBK_PID=$!
          echo "XbK starting..."
          
          timeout=100
          elapsed=0
          adminUrl="$XBK_URL/admin"
          
          while [ $elapsed -lt $timeout ]; do
            if curl -s -f "$adminUrl" > /dev/null 2>&1; then
              echo "XbK is accessible"
              break
            else
              echo "Waiting for XbK to be accessible..."
            fi
            sleep 5
            elapsed=$((elapsed + 5))
          done
          
          cd ${{ env.UMT_DIR }}
          echo "Running tests..."
          mkdir -p reports
          dotnet test --settings:test.runsettings --logger:"html;LogFileName=${{ env.UMT_DIR }}/reports/logFile.html"

      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: playwright-report
          path: ${{ env.UMT_DIR }}\reports\
          retention-days: 10
